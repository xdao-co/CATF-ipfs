name: release

"on":
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Existing git tag to release (e.g. v1.2.3)"
                required: true
                type: string

permissions:
    contents: write

env:
    GO_VERSION: "1.22.x"

jobs:
    test:
        name: test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout CATF-ipfs
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Checkout CATF
              uses: actions/checkout@v4
              with:
                  repository: xdao-co/CATF
                  path: CATF
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Wire local CATF module
              run: |
                  go mod edit -replace xdao.co/catf=./CATF/src
                  go mod download

            - name: Run unit tests
              run: |
                  go test ./...

    build:
        name: build (${{ matrix.goos }}/${{ matrix.goarch }})
        runs-on: ubuntu-latest
        needs: test
        strategy:
            fail-fast: false
            matrix:
                include:
                    - goos: linux
                      goarch: amd64
                    - goos: darwin
                      goarch: arm64

        steps:
            - name: Checkout CATF-ipfs
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Checkout CATF
              uses: actions/checkout@v4
              with:
                  repository: xdao-co/CATF
                  path: CATF
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Wire local CATF module
              run: |
                  go mod edit -replace xdao.co/catf=./CATF/src
                  go mod download

            - name: Build
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
              run: |
                  set -euo pipefail
                  BIN=xdao-casgrpcd-ipfs
                  OUTDIR=dist
                  mkdir -p "$OUTDIR"

                  OUT_BASENAME="${BIN}_${GOOS}_${GOARCH}"
                  OUT_PATH="$OUTDIR/$OUT_BASENAME"

                  go build -trimpath -ldflags "-s -w" -o "$OUT_PATH" ./cmd/xdao-casgrpcd-ipfs

                  tar -czf "$OUTDIR/${OUT_BASENAME}.tar.gz" -C "$OUTDIR" "$OUT_BASENAME"
                  shasum -a 256 "$OUTDIR/${OUT_BASENAME}.tar.gz" > "$OUTDIR/${OUT_BASENAME}.tar.gz.sha256"

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: dist/*.tar.gz*

    release:
        name: GitHub Release
        needs: build
        runs-on: ubuntu-latest
        if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}
        steps:
            - name: Checkout (tags)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  pattern: dist-*
                  merge-multiple: true
                  path: dist

            - name: Publish release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
                  name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
                  generate_release_notes: true
                  files: |
                      dist/*.tar.gz
                      dist/*.tar.gz.sha256
